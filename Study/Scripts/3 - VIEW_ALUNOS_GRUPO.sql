CREATE OR REPLACE VIEW VW_ALUNOS_GRUPO AS
SELECT
  ALUN.ID_ALUNO,
  ALUN.MATRICULA,
  ALUN.NOME,
  ALUN.EMAIL,
  ALUN.TELEFONE,
  ALUN.FOTO,
  ALUN.TOKEN AS TOKEN,
  PART.TIPO,
  GRUP.ID_GRUPO_ESTUDO,
  GRUP.NOME AS NOME_GRUPO,
  ALUN.VERSION,
  SUM(CASE AVAL.AVALIACAO_POSITIVA WHEN 1 THEN 1 WHEN 0 THEN 0 END) AS AVAL_POSITIVAS,
  SUM(CASE AVAL.AVALIACAO_POSITIVA WHEN 1 THEN 0 WHEN 0 THEN 1 END) AS AVAL_NEGATIVAS
FROM ALUNOS ALUN
INNER JOIN PARTICIPACOES PART ON PART.ID_ALUNO = ALUN.ID_ALUNO
INNER JOIN GRUPOS_ESTUDO GRUP ON GRUP.ID_GRUPO_ESTUDO = PART.ID_GRUPO_ESTUDO
LEFT JOIN AVALIACOES AVAL ON AVAL.ID_AVALIADO = ALUN.ID_ALUNO
WHERE PART.PARTICIPANDO IS NOT NULL
GROUP BY ALUN.ID_ALUNO, GRUP.ID_GRUPO_ESTUDO;